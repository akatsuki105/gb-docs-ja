# MBC3

対応カートリッジ: 最大2MBのROM and/or 32KBのRAM and タイマー

MBC3は、最大2MBのROM（128バンク）と32KBのRAM（4バンク）にアクセスできるだけでなく、RTC（Real Time Clock）を内蔵しています。

RTCは、外部に32.768kHzの水晶振動子と外部電池（ゲームボーイの電源を切っても動き続けさせたい場合）を必要とします。

## メモリ

### 0000-3FFF - ROMバンク 00 (R)

ROMの最初の16KiB

### 4000-7FFF - ROMバンク 01-7F (R)

MBC1と同じですが、バンク`$20`、`$40`、`$60`はサポートしていません。

### A000-BFFF - RAMバンク 00-03 (R/W)

現在のバンク番号/RTCレジスタの選択状況に応じて、このメモリ空間は、8KiBの外部RAMバンクとして使われるか、1つのRTCレジスタとして使われます。

詳しくは[下記参照](#4000-5fff---ramバンクrtcレジスタの選択レジスタ-w)

## レジスタ

### A000-BFFF - RTCレジスタ 08-0C (R/W)

現在のバンク番号/RTCレジスタの選択状況（下記参照）に応じて、このメモリ空間は、8KiBの外部RAMバンクとして使われるか、1つのRTCレジスタとして使われます。

詳しくは[下記参照](#4000-5fff---ramバンクrtcレジスタの選択レジスタ-w)

### 0000-1FFF - RAM/タイマー有効化フラグ (W)

ほとんどMBC1のそれと同じで、`0Ah`の値は外部RAMとRTCレジスタへの読み書きを有効にします。値が`00h`の場合は、どちらも無効になります。

### 2000-3FFF - ROMバンク番号 (W)

MBC1と同じですが、ROMバンク番号の7bit全体がこのアドレスに直接書き込まれます。

MBC1と同様に、値を`00h`にすると、代わりにバンク`01h`が選択されます。その他の値01～7Fhは、対応するROMバンクを選択します。

### 4000-5FFF - RAMバンク/RTCレジスタの選択レジスタ (W)

MBC1のRAMバンクモードと同様に、ここに`00h..03h`の範囲の値を書き込むと、対応する外部RAMバンクがある場合は、`$A000..BFFF`のメモリにマッピングされます。

`08h..0Ch`の値を書き込むと、対応するRTCレジスタが`$A000-BFFF`のメモリにマッピングされます。このレジスタは、このエリアのどのアドレスにアクセスしても読み書きできます。

### 6000-7FFF - ラッチクロックデータ (W)

このレジスタに00h、01hの順に書き込むと、現在の時刻がRTCレジスタにラッチ(保存?)されます。

ラッチされたデータは、書き込み00hから01hの手順を繰り返すことで再びラッチされるまで変化しません。

これにより、時計が動いているでもRTCレジスタを読み出すことができます。

**The Clock Counter Registers**

```
08h  RTC S   Seconds   0-59 (0-3Bh)
09h  RTC M   Minutes   0-59 (0-3Bh)
0Ah  RTC H   Hours     0-23 (0-17h)
0Bh  RTC DL  Dayカウンタの下位8bit (0-FFh)
0Ch  RTC DH  Dayカウンタの上位1bit, キャリー, Haltフラグ
      Bit 0  Dayカウンタの上位1bit (Bit 8)
      Bit 6  Halt (0=Active, 1=Stop Timer)
      Bit 7  Dayカウンタのキャリー (1=Counter Overflow)
```

Haltフラグ(0Chのbit6)は、RTCレジスタに書き込む前にセットする必要があります。

**Dayカウンタ**

Dayカウンタは合計9bitで、0..511（0..1FFh）の範囲で日数をカウントできます。

この値がオーバーフローすると、Dayカウンタのキャリービット(bit7)がセットされます。

この場合、キャリービットはプログラムでリセットされるまでセットされたままになります。

Dayカウンタのオフセットは、バッテリーRAMに保存できます。例えば、ゼロでないDayカウンタを読むたびに、このカウンタとRAM内のオフセットを加算し、カウンタをゼロにリセットします。

この方法を使えば、任意の日数をカウントすることができ、少なくとも511日ごとにカートリッジが使用されていれば、プログラムは1万年の間、日数をカウントすることも可能です。

**遅延**

RTCレジスタにアクセスする際には、4msの遅延（CPUが通常速度の場合、4サイクル）を設けてアクセスすることを推奨します。

