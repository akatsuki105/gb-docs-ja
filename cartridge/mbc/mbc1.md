# MBC1

```
  ROM:   最大2MB
  RAM:   最大32KB

  使用例:
    - ポケットモンスター 赤・緑・青
    - サガ2秘宝伝説
```

MBC1は、最初に開発されたMBCチップです。

(MBC3やMBC5などの)後発のMBCチップも基本的に動作の仕組みはMBC1と同じです。

`0x0000..7FFF`は、ROMからの読み出し と MBCの制御レジスタへの書き込み の両方に使われています。

## メモリ

### 0000-3FFF - ROMバンク X0 (R)

この領域には、ROMの最初の16KB（バンク0）がマッピングされています。

モード1(後述)ではバンク番号が`0x20,0x40,0x60`のバンクもここにマッピングすることができます。

### 4000-7FFF - ROMバンク 01-7F (R)

この領域には、ROMバンクのどれかがマッピングできます。

[バンクレジスタ](#2000-3fff---romバンク番号-w)が\$00になるようなバンク(バンク番号が\$00/\$20/\$40/\$60)は通常、ここには指定できません。

もし\$00を指定した場合は、1つ大きいバンク(例えば\$0なら\$1)にマッピングされます。

### A000-BFFF - RAMバンク 00-03 (R/W)

この領域には、 カートリッジに内蔵されたRAM のバンクのどれかがマッピングされます。

## レジスタ

### 0000-1FFF - RAM有効フラグ (W)

```
  Bit  Expl.
  0-3  RAM有効化フラグ(0x0A=RAM有効化, それ以外はRAM無効化)
  4-7  不使用(無視)
```

SRAMを読み書きする前に、このアドレス空間に`0x0A`を書き込むことで、SRAMを有効にする必要があります。

SRAMの内容が破壊されないように、SRAMを読み書きするときだけ有効にすることが一般的です。

### 2000-3FFF - ROMバンク番号 (W)

```
  Bit  Expl.
  0-4  ROMバンク番号 (0..31)
  5-7  不使用(無視)
```

ここには、ROMバンク番号の下位5bitが入ります。

ROMサイズが512KBよりも大きいカートリッジ、つまり1MB以上のカートリッジでは、5bitだけではバンク番号を指定するのに足りないため、後述のレジスタと合わせて使用する必要があります。

また、書き込んだバンク番号がカートリッジのバンク数よりも大きい場合、バンク番号は必要なビット数にマスクされます。例えば、バンク数が16個つまり、256KBのカートリッジでは、バンク番号は`0x0F`でマスクされます。

電源ON時、ROMのバンク番号はデフォルトで`0x01`にセットされています。

00が書き込まれると、MBCはそれをバンク01として扱います。バンク00hは通常、`$0000..3FFF`の範囲にマッピングされているので、バンク00を選択できないことは通常問題になりません。

しかし、セカンダリバンクレジスタを使用してROMバンクの上位bitを指定する必要のあるような大型のカートリッジでは、バンク`$20`、`$40`、`$60`についても同じことが起こり、これらのアドレスではこのレジスタを00にする必要があります。これらのROMバンクにアクセスしようとすると、代わりにバンク`$21`、`$41`、`$61`が選択されます。

バンク`$20`、`$40`、`$60`にアクセスする唯一の方法は、モード1(後述)に入り、`$0000..3FFF`の範囲をリマップすることです。

### 4000-5FFF - RAMバンク番号 (W)

この2bitのレジスタは、

- (32KB RAMカートのみ)00~03の範囲でRAMバンクを選択するため、
- (1MB ROM以上のカートのみ)ROMバンク番号の上位2bit（bit5-6）を指定するため

に使用することができます。

ROMもRAMも十分に大きくない場合は、このレジスタに値をセットしても何も起こりません。

[MBC1m](mbc1m.md#mbc1m)では、この2bitのレジスタは、代わりにROMバンク番号の4-5bitとして適用され、`$2000..3FFF`の5bitのバンクレジスタの最上位bitは無視されます。

### 6000-7FFF - モードセレクト (W)

```
  Bit   Expl.
  0     モード選択
          0: ROM/RAM = 2MB/8KB
          1: ROM/RAM = 512KB/32KB
  1-7   不使用(無視)
```

カートリッジが拡張ROMバンクレジスタを必要としないROMサイズ(512KB以内)、RAMサイズ(8KB以内)の場合は、このレジスタに値をセットしても何も起こりません。

プログラムはいつでも2つのモードを切り替え可能です。

```
00 = 通常ROMバンクモード (デフォルト)
01 = RAMバンクモード / アドバンスドROMバンクモード
```

モード0では、[セカンダリバンクレジスタ](#4000-5fff---ramバンク番号--romバンク番号の上位bit-w)の2bitは、`$4000..7FFF`のバンク付きROMエリアにのみ影響を与えることができます。

カートリッジのROMが1MiB未満で、RAMが8KiBより大きい場合、セカンダリバンクレジスタをどう設定しようが`$4000..7FFF`のバンク番号は影響を受けません。

つまり、実際には、RAMバンキングは無効となり、`$A000..BFFF`はRAMのバンク0にしかアクセスできないようにロックされ、セカンダリバンキングレジスタの2bitは完全に無視されることになります。

モード1では、カートリッジが(8KiBより大きい)大容量のRAMカートか(1MB以上の)大容量のROMカートかによって動作が異なります。

大容量RAMカートリッジの場合、モード1に切り替えると、RAMバンキングが有効になり、（RAMが有効な場合）直ちに`$A000..BFFF`のRAM領域が2ビットのセカンダリバンクレジスタで選択されたバンクに切り替わります。

大容量ROMカートリッジの場合、モード1では、`$4000..7FFF`の動作はモード0と同じですが、さらにバンク不可能なバンク0の`$0000..3FFF`が2ビットのセカンダリバンクレジスタの影響を受けるようになり、バンク`$00`、`$20`、`$40`、`$60`の間で切り替えられるようになりました。これらのバンクは、モード0ではアクセスできず、`$4000..7FFF`のバンク付きROMエリアにマッピングできません。
