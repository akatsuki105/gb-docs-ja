# MBC1

対応カートリッジ: 最大で2MBのROM and/or 32KiB RAM

ゲームボーイ用のMBCチップはこれが初めて開発されたものです。

MBCチップは、一番新しいMBCチップであっても動作の仕組みは同じなので、あるMBCチップから別のMBCチップへプログラムをアップグレードしたり、複数のMBCチップに対応させたりすることは比較的容易です。

なお、`$0000..7FFF`のメモリは、ROMからの読み出しとMBCの制御レジスタへの書き込みの両方に使われています。

## メモリ

### 0000-3FFF - ROMバンク X0 (R)

このエリアには通常、カートリッジROMの最初の16KiB（バンク0）が格納されています。

モード1(後述)ではバンク番号が$20/$40/$60のバンクにもスイッチすることができます。

同様に、[MBC1m](mbc1m.md#mbc1m)ではモード1でバンク番号が$10/$20/$30のバンクにスイッチ可能です。

### 4000-7FFF - ROMバンク 01-7F (R)

この領域には、ROMの16KiBのバンクのどれかが入る可能性があります。

[バンクレジスタ](#2000-3fff---romバンク番号-w)が\$00になるようなバンク(バンク番号が\$00/\$20/\$40/\$60)は通常、ここには指定できません。

もし\$00を指定した場合は、1つ大きいバンク(例えば\$0なら\$1)にマッピングされます。

### A000-BFFF - RAMバンク 00-03 (R/W)

この領域ではカートリッジの外部RAMが格納されています。(カートリッジによっては外部RAMが存在しないものもあります)

ゲームボーイの電源を切った状態や、カートリッジを取り外した状態でもゲームデータを保存できるように、外部RAMは電池式のものが多いです。

利用可能なRAMのサイズは、

- 2KiB(アドレス`$A000-$A7FF`)
- 8KiB(アドレス`$A000-$BFFF`)
- 32KiB(アドレス`$A000-$BFFF`でバンク4つ)

があります。

## レジスタ

### 0000-1FFF - RAM有効フラグ (W)

外部RAMを読み書きする前に、このアドレス空間に書き込むことで、外部RAMを有効にする必要があります。

ゲームボーイの電源OFF時に外部RAMの内容が破壊されないようにするために、外部RAMにアクセスした後は無効にすることをお勧めします。

通常、以下の値を使用します。

```
00h  RAM無効 (デフォルト)
0Ah  RAM有効
```

実質的に、下位4ビットが`0x0a`ならどんな値であってもRAMを有効にし、それ以外の値はRAMを無効にします。

ゲームボーイの電源を切ると、RAMは自動的に無効になります。なぜ`0x0a`がRAMを有効にするための値なのかは不明です。

### 2000-3FFF - ROMバンク番号 (W)

この5bitのレジスタは、ROMのバンク番号を選択するためのものです。とりうる値の範囲は`$01~$1F`です。

上位3bitは無視されます。例えば`$E1`(`0b1110_0001`)を書き込んだ場合、バンク01が選択されます。

バンク番号がカートリッジのバンク数よりも大きい値に設定されている場合、バンク番号は必要なビット数にマスクされます。

例えば、256KiBのカートでは、16個のバンクすべてが指定可能であるためには4bitのバンク番号が必要なだけなので、このレジスタは4bitにマスクされており、上位4bitは無視されます。

5bit以上のバンク番号が必要な大型カートリッジでは、`$4000..5FFF`のセカンダリバンクレジスタ(後述)を使用して、バンク番号の上位2bitを補います。

```
ROMバンク番号 = (セカンダリバンク番号 << 5) + ROMバンク番号
```

電源ON時、ROMのバンク番号はデフォルトで01に設定されています。

00が書き込まれると、MBCはそれをバンク01として扱います。バンク00hは通常、`$0000..3FFF`の範囲にマッピングされているので、バンク00を選択できないことは通常問題になりません。

しかし、セカンダリバンクレジスタを使用してROMバンクの上位bitを指定する必要のあるような大型のカートリッジでは、バンク`$20`、`$40`、`$60`についても同じことが起こり、これらのアドレスではこのレジスタを00にする必要があります。これらのROMバンクにアクセスしようとすると、代わりにバンク`$21`、`$41`、`$61`が選択されます。

バンク`$20`、`$40`、`$60`にアクセスする唯一の方法は、モード1(後述)に入り、`$0000..3FFF`の範囲をリマップすることです。

この範囲には割り込みハンドラが含まれているため、ゲーム開発者にとっては問題があり、通常は[MBC1m](mbc1m.md#mbc1m)でのみ使用されます。

### 4000-5FFF - RAMバンク番号 / ROMバンク番号の上位bit (W)

この2bitのレジスタは、

- (32KiB RAMカートのみ)00~03の範囲でRAMバンクを選択するため、
- (1MiB ROM以上のカートのみ)ROMバンク番号の上位2bit（bit5-6）を指定するため

に使用することができます。

ROMもRAMも十分に大きくない場合は、このレジスタに値をセットしても何も起こりません。

[MBC1m](mbc1m.md#mbc1m)では、この2bitのレジスタは、代わりにROMバンク番号の4-5bitとして適用され、`$2000..3FFF`の5bitのバンクレジスタの最上位bitは無視されます。

### 6000-7FFF - バンクモードセレクト (W)

この1bitのレジスタは、2つのMBC1のバンクモードを選択し、上述の[セカンダリバンクレジスタ](#4000-5fff---ramバンク番号--romバンク番号の上位bit-w)の動作を制御します。

カートリッジがセカンダリバンクレジスタを必要としないROMサイズ(512KiB以内)、RAMサイズ(8KiB以内)の場合は、このレジスタに値をセットしても何も起こりません。

プログラムはいつでも2つのモードを切り替え可能です。

```
00 = 通常ROMバンクモード (デフォルト)
01 = RAMバンクモード / アドバンスドROMバンクモード
```

モード0では、[セカンダリバンクレジスタ](#4000-5fff---ramバンク番号--romバンク番号の上位bit-w)の2bitは、`$4000..7FFF`のバンク付きROMエリアにのみ影響を与えることができます。

カートリッジのROMが1MiB未満で、RAMが8KiBより大きい場合、セカンダリバンクレジスタをどう設定しようが`$4000..7FFF`のバンク番号は影響を受けません。

つまり、実際には、RAMバンキングは無効となり、`$A000..BFFF`はRAMのバンク0にしかアクセスできないようにロックされ、セカンダリバンキングレジスタの2bitは完全に無視されることになります。

モード1では、カートリッジが(8KiBより大きい)大容量のRAMカートか(1MB以上の)大容量のROMカートかによって動作が異なります。

大容量RAMカートリッジの場合、モード1に切り替えると、RAMバンキングが有効になり、（RAMが有効な場合）直ちに`$A000..BFFF`のRAM領域が2ビットのセカンダリバンクレジスタで選択されたバンクに切り替わります。

大容量ROMカートリッジの場合、モード1では、`$4000..7FFF`の動作はモード0と同じですが、さらにバンク不可能なバンク0の`$0000..3FFF`が2ビットのセカンダリバンクレジスタの影響を受けるようになり、バンク`$00`、`$20`、`$40`、`$60`の間で切り替えられるようになりました。これらのバンクは、モード0ではアクセスできず、`$4000..7FFF`のバンク付きROMエリアにマッピングできません。
