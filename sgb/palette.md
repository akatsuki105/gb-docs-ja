# カラーパレット

## 🎨 パレットの種類

SGB/SNESには、16色のパレットが8つ用意されており、パレットの各色として32768色（15bit）の中から選択して使うことができます。

パレット0~3は**SGBカラーパレット**と呼ばれ、ゲーム画面の着色に使用され、それぞれのパレットの最初の4色のみが使用されます。

パレット4~7は**SGBボーダーパレット**と呼ばれ、SGBボーダーに使用され、各パレットの16色すべてを使用することができます。

## 🌈 色データのフォーマット

パレットが持っている色データはRGBで16bitで次のように表されます。

```
FEDC BA98 7654 3210
-------------------
0BBB BBGG GGGR RRRR
```

SNESで使う24bitのRGB色データに変換するには

```
(color & 0xF8) << 7 | (color & 0xF800) >> 6 | (color & 0xF80000) >> 19
```

色データのエンコーディングはリトルエンディアンであり、bit0-7(`GGGR_RRRR`)が最初のアドレスに、bit8-15(`0BBB_BBGG`)が次のアドレスになります。

## ⛓ パレットの色0の制約

パレットは16色を持てますが、最初の色(色0)は透明色として扱われ、色0のところには、代わりにバックドロップ色が表示されます。

バックドロップ色は通常、色0に割り当てられた直近の色で定義されます。色0の割り当てにはパレット番号は関係なく、全てのパレットのうち最近色0として割り当てられた色データをバックドロップ色として使います。

なので、事実上、ゲーム画面のパレットにはそれぞれ3色のカスタムカラーしか設定できず、SGBボーダーのパレットにはそれぞれ15色しか設定できません。

さらに、すべてのパレットに色0を使用することができ、すべてのパレットが同じ色を共有することになります。

## 🔲 グレーシェードからの遷移

SGBは、ゲームボーイのビデオコントローラの映像信号を読み取るため、その信号の濃淡をそのままSNESの色に変換しています。

```
白     ->  色番号0(パレットの色0)
白灰   ->  色番号1(パレットの色1)
黒灰   ->  色番号2(パレットの色2)
黒     ->  色番号3(パレットの色3)
```

### ゲームボーイのBGP/OBPレジスタ

レジスタ`BGP,OBP0,OBP1`にそれぞれ`0xE4`(`0b1110_0100`)を設定すると、

```
bit0-1(色番号0) -> 0(白)
bit2-3(色番号1) -> 1(白灰)
bit4-5(色番号2) -> 2(黒灰)
bit6-7(色番号3) -> 3(黒)
```

となるため、GBの色番号0~3をSNESの色番号0~3に直接変換することができます。

## 🎞 システムカラーパレット

実際に表示されるパレットとは別に、SNESのRAMには4色ずつ最大512個のパレットを定義することができます。

これをシステムカラーパレットといいます。実際のスーファミのパレットはハードウェアパレットということがあります。

このパレットはRAM上に保存されているだけで、表示されている画像とは何の関係もありませんが、あらかじめ定義された色を実際に見えるパレットに転送する際には、個別のコマンドパケットでパレットデータを転送する場合よりも若干早く転送することができます。
